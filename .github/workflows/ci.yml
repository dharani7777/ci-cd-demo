name: CI-CD

on:
  push:
    branches: ["main"]

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    env:
      IMAGE_NAME: ghcr.io/${{ github.repository }}:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Login to GitHub Container Registry
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build Docker image
      - name: Build Docker image
        run: docker build -t $IMAGE_NAME .

      # Push Docker image
      - name: Push Docker image
        run: docker push $IMAGE_NAME

      # Create Kubernetes cluster (kind)
      - name: Create kind cluster
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: ci-cluster

      # Deploy to Kubernetes
      - name: Deploy application
        run: |
          kubectl create deployment web --image=$IMAGE_NAME
          kubectl expose deployment web --type=NodePort --port=80

      # Verify deployment
      - name: Verify rollout
        run: kubectl rollout status deployment/web --timeout=120s

      - name: Show cluster resources
        run: |
          kubectl get pods -o wide
          kubectl get svc -o wide

